import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from io import BytesIO
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.utils import ImageReader

# -------------------------------------
# FUNKCE: Vygeneruje body na kružnici
# -------------------------------------
def generate_circle_points(center, radius, num_points):
    angles = np.linspace(0, 2 * np.pi, num_points, endpoint=False)
    x_points = center[0] + radius * np.cos(angles)
    y_points = center[1] + radius * np.sin(angles)
    return x_points, y_points

# -------------------------------------
# FUNKCE: Vykreslí figuru (vrací fig)
# -------------------------------------
def create_figure(x_points, y_points, center_x, center_y, radius, color, unit):
    fig, ax = plt.subplots(figsize=(6, 6))
    ax.scatter(x_points, y_points, color=color, label="Body na kružnici")
    ax.plot(center_x, center_y, 'ko', label="Střed kruhu")

    ax.set_xlabel(f"X [{unit}]")
    ax.set_ylabel(f"Y [{unit}]")
    ax.set_aspect('equal', 'box')
    ax.grid(True)
    ax.legend()
    ax.set_title("Body rovnoměrně rozložené na kružnici")

    padding = radius * 1.2
    ax.set_xlim(center_x - padding, center_x + padding)
    ax.set_ylim(center_y - padding, center_y + padding)

    return fig

# -------------------------------------
# FUNKCE: Vytvoří PDF s parametry + grafem
# -------------------------------------
def create_pdf(fig, params, author_info):
    buffer = BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    # Nadpis
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, height - 50, "Výstup: Body na kružnici")

    # Parametry
    c.setFont("Helvetica", 12)
    y_pos = height - 80
    for label, value in params.items():
        c.drawString(50, y_pos, f"{label}: {value}")
        y_pos -= 20

    # Obrázek – uložíme z fig do paměti
    img_buffer = BytesIO()
    fig.savefig(img_buffer, format="png", dpi=150)
    img_buffer.seek(0)
    image = ImageReader(img_buffer)

    c.drawImage(image, 50, y_pos - 300, width=400, preserveAspectRatio=True, mask='auto')

    # Autor
    c.setFont("Helvetica-Oblique", 10)
    c.drawString(50, 40, f"Autor: {author_info['name']} | Kontakt: {author_info['contact']}")

    c.save()
    buffer.seek(0)
    return buffer

# -------------------------------------
# STRÁNKA: Generátor kružnice
# -------------------------------------
def show_circle_generator():
    st.title("🔵 Generátor bodů na kružnici")

    st.header("📥 Vstupy")
    col1, col2 = st.columns(2)
    with col1:
        center_x = st.number_input("Souřadnice X středu", value=0.0, format="%.2f")
        radius = st.number_input("Poloměr kruhu", min_value=0.01, value=1.0, step=0.1, format="%.2f")
    with col2:
        center_y = st.number_input("Souřadnice Y středu", value=0.0, format="%.2f")
        num_points = st.slider("Počet bodů", min_value=3, max_value=360, value=36)

    color = st.color_picker("Barva bodů", "#ff0000")
    unit = st.text_input("Jednotka os (např. m, mm, km):", value="m")

    # Výpočet bodů
    x_points, y_points = generate_circle_points((center_x, center_y), radius, num_points)

    # Vykreslení grafu pro Streamlit
    st.header("📊 Výsledný graf")
    fig_streamlit = create_figure(x_points, y_points, center_x, center_y, radius, color, unit)
    st.pyplot(fig_streamlit)

    # Tabulka souřadnic
    with st.expander("📋 Zobrazit souřadnice bodů"):
        data = {
            f"X [{unit}]": np.round(x_points, 3),
            f"Y [{unit}]": np.round(y_points, 3),
        }
        st.table(data)

    # PDF export
    st.header("📄 Export do PDF")

    # Parametry pro PDF
    params = {
        "Střed kruhu (X, Y)": f"({center_x}, {center_y})",
        "Poloměr": f"{radius} {unit}",
        "Počet bodů": num_points,
        "Barva": color,
        "Jednotka": unit
    }

    author_info = {
        "name": "Tvoje jméno zde",
        "contact": "tvůj.email@example.com"
    }

    if st.button("📤 Vytvořit PDF"):
        # Vytvoříme nový graf pro PDF (abychom nezničili Streamlit figuru)
        fig_pdf = create_figure(x_points, y_points, center_x, center_y, radius, color, unit)
        pdf_file = create_pdf(fig_pdf, params, author_info)

        st.download_button(

