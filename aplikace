import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from io import BytesIO
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.utils import ImageReader

# -------------------------------------
# FUNKCE: Vygeneruje body na kruÅ¾nici
# -------------------------------------
def generate_circle_points(center, radius, num_points):
    angles = np.linspace(0, 2 * np.pi, num_points, endpoint=False)
    x_points = center[0] + radius * np.cos(angles)
    y_points = center[1] + radius * np.sin(angles)
    return x_points, y_points

# -------------------------------------
# FUNKCE: VykreslÃ­ figuru (vracÃ­ fig)
# -------------------------------------
def create_figure(x_points, y_points, center_x, center_y, radius, color, unit):
    fig, ax = plt.subplots(figsize=(6, 6))
    ax.scatter(x_points, y_points, color=color, label="Body na kruÅ¾nici")
    ax.plot(center_x, center_y, 'ko', label="StÅ™ed kruhu")

    ax.set_xlabel(f"X [{unit}]")
    ax.set_ylabel(f"Y [{unit}]")
    ax.set_aspect('equal', 'box')
    ax.grid(True)
    ax.legend()
    ax.set_title("Body rovnomÄ›rnÄ› rozloÅ¾enÃ© na kruÅ¾nici")

    padding = radius * 1.2
    ax.set_xlim(center_x - padding, center_x + padding)
    ax.set_ylim(center_y - padding, center_y + padding)

    return fig

# -------------------------------------
# FUNKCE: VytvoÅ™Ã­ PDF s parametry + grafem
# -------------------------------------
def create_pdf(fig, params, author_info):
    buffer = BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    # Nadpis
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, height - 50, "VÃ½stup: Body na kruÅ¾nici")

    # Parametry
    c.setFont("Helvetica", 12)
    y_pos = height - 80
    for label, value in params.items():
        c.drawString(50, y_pos, f"{label}: {value}")
        y_pos -= 20

    # ObrÃ¡zek â€“ uloÅ¾Ã­me z fig do pamÄ›ti
    img_buffer = BytesIO()
    fig.savefig(img_buffer, format="png", dpi=150)
    img_buffer.seek(0)
    image = ImageReader(img_buffer)

    c.drawImage(image, 50, y_pos - 300, width=400, preserveAspectRatio=True, mask='auto')

    # Autor
    c.setFont("Helvetica-Oblique", 10)
    c.drawString(50, 40, f"Autor: {author_info['name']} | Kontakt: {author_info['contact']}")

    c.save()
    buffer.seek(0)
    return buffer

# -------------------------------------
# STRÃNKA: GenerÃ¡tor kruÅ¾nice
# -------------------------------------
def show_circle_generator():
    st.title("ğŸ”µ GenerÃ¡tor bodÅ¯ na kruÅ¾nici")

    st.header("ğŸ“¥ Vstupy")
    col1, col2 = st.columns(2)
    with col1:
        center_x = st.number_input("SouÅ™adnice X stÅ™edu", value=0.0, format="%.2f")
        radius = st.number_input("PolomÄ›r kruhu", min_value=0.01, value=1.0, step=0.1, format="%.2f")
    with col2:
        center_y = st.number_input("SouÅ™adnice Y stÅ™edu", value=0.0, format="%.2f")
        num_points = st.slider("PoÄet bodÅ¯", min_value=3, max_value=360, value=36)

    color = st.color_picker("Barva bodÅ¯", "#ff0000")
    unit = st.text_input("Jednotka os (napÅ™. m, mm, km):", value="m")

    # VÃ½poÄet bodÅ¯
    x_points, y_points = generate_circle_points((center_x, center_y), radius, num_points)

    # VykreslenÃ­ grafu pro Streamlit
    st.header("ğŸ“Š VÃ½slednÃ½ graf")
    fig_streamlit = create_figure(x_points, y_points, center_x, center_y, radius, color, unit)
    st.pyplot(fig_streamlit)

    # Tabulka souÅ™adnic
    with st.expander("ğŸ“‹ Zobrazit souÅ™adnice bodÅ¯"):
        data = {
            f"X [{unit}]": np.round(x_points, 3),
            f"Y [{unit}]": np.round(y_points, 3),
        }
        st.table(data)

    # PDF export
    st.header("ğŸ“„ Export do PDF")

    # Parametry pro PDF
    params = {
        "StÅ™ed kruhu (X, Y)": f"({center_x}, {center_y})",
        "PolomÄ›r": f"{radius} {unit}",
        "PoÄet bodÅ¯": num_points,
        "Barva": color,
        "Jednotka": unit
    }

    author_info = {
        "name": "Tvoje jmÃ©no zde",
        "contact": "tvÅ¯j.email@example.com"
    }

    if st.button("ğŸ“¤ VytvoÅ™it PDF"):
        # VytvoÅ™Ã­me novÃ½ graf pro PDF (abychom nezniÄili Streamlit figuru)
        fig_pdf = create_figure(x_points, y_points, center_x, center_y, radius, color, unit)
        pdf_file = create_pdf(fig_pdf, params, author_info)

        st.download_button(

